<script>
/* Apps Script Web App URL (new) */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyFpEyd3Sd7h6Iq4ECwRHNiiI2Oapa4yRMskVKC-BbjYbsIwFUbtZPz_7y4-XA-FhgPIg/exec";

const guestList = document.getElementById('guestList');
const addBtn = document.getElementById('addBtn');
const submitBtn = document.getElementById('submitBtn');
const okBox = document.getElementById('okBox');
const errBox = document.getElementById('errBox');
const sisterNameInput = document.getElementById('sisterName');
const globalNotesInput = document.getElementById('globalNotes');
const hero = document.getElementById('hero');

if (!hero.src || hero.src.includes('PHOTO_URL_HERE')) hero.style.display = 'none';

/* Compliment rotator */
const words = ["Sophisticated","Smart","Elegant","Radiant","Gorgeous","Beautiful","Adventurous","Kind-Hearted"];
const complimentEl = document.getElementById('complimentWord');
let w = 0; setInterval(()=>{ w = (w+1)%words.length; complimentEl.textContent = words[w]; }, 2500);

/* Guest card factory */
function guestCard(){
  const div=document.createElement('div');
  div.className='card guest';
  div.innerHTML=`
    <div class="row">
      <div><label>Guest name</label><input placeholder="e.g., Phoebe Buffay (Singer of Smelly Cat ğŸ¶)" data-k="name" required></div>
      <div><label>Guest contact</label><input placeholder="e.g., +44 71... or Central Perk booth #3 â˜•" data-k="phone"></div>
    </div>
    <div style="margin-top:10px;">
      <label>Notes</label>
      <textarea placeholder="e.g., Chandler-level sarcasm preferred ğŸ™ƒ&#10;Vegetarian option (Joeyâ€™s meatball sub not required)&#10;Will do a Phoebe-style wedding song performance ğŸ¸" data-k="notes"></textarea>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;">
      <button type="button" class="btn" onclick="this.closest('.card').remove()">Remove</button>
    </div>`;
  return div;
}
function addGuest(){ guestList.appendChild(guestCard()); }
addBtn.addEventListener('click', addGuest); addGuest();

/* Emoji confetti */
function launchConfetti(){
  const confetti=document.getElementById('confetti');
  confetti.innerHTML='';
  const emojis=["ğŸ’–","âœ¨","ğŸ¥‚","ğŸŠ"];
  for(let i=0;i<36;i++){
    const span=document.createElement('span');
    span.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    span.style.left=Math.random()*100+"vw";
    span.style.animationDuration=(2+Math.random()*3)+"s";
    span.style.fontSize=(20+Math.random()*10)+"px";
    confetti.appendChild(span);
  }
  setTimeout(()=>confetti.innerHTML='',5000);
}

/* Helpers */
function showError(msg){
  errBox.textContent = msg || 'Could not send. Please try again.';
  errBox.style.display='block';
}
function showSuccess(text){
  okBox.textContent = text;
  okBox.style.display='block';
  requestAnimationFrame(()=> okBox.classList.add('show'));
  launchConfetti();
}

/* Submit handler with JSON + timeout */
async function submit(){
  okBox.classList.remove('show'); okBox.style.display='none';
  errBox.style.display='none';

  const cards=[...guestList.querySelectorAll('.card.guest')];
  if(!cards.length){
    showError('Add at least one guest name.');
    return;
  }

  const guests=cards.map(card=>{
    const obj={}; card.querySelectorAll('[data-k]').forEach(i=>obj[i.dataset.k]=i.value.trim());
    return obj;
  }).filter(g=>g.name);

  const payload={
    sisterName: sisterNameInput.value.trim() || "Tariro (Pinky)",
    notes: globalNotesInput.value.trim(),
    guests
  };

  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), 12000); // 12s timeout

  try{
    submitBtn.disabled=true; submitBtn.classList.add('loading'); submitBtn.textContent='Sending';

    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    clearTimeout(t);

    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      throw new Error(`Server error (${res.status}) ${txt}`);
    }

    // Expect: { ok:true, submissionId, guestsAdded }
    const data = await res.json().catch(()=> ({}));
    if (!data.ok) throw new Error('Submission failed on server.');

    showSuccess(`â€œHow you doinâ€™?â€ Guests saved: ${data.guestsAdded} âœ¨`);

    // Reset inputs
    guestList.innerHTML=''; addGuest(); globalNotesInput.value='';
  }catch(e){
    if (e.name === 'AbortError') {
      showError('Network timeout. Please try again.');
    } else {
      showError(e.message || 'Could not send. Please try again.');
    }
  }finally{
    submitBtn.classList.remove('loading'); submitBtn.disabled=false; submitBtn.textContent='Send to my planner ğŸ’Œ';
  }
}
submitBtn.addEventListener('click', submit);
</script>
